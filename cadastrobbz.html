<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Roupas - Admin</title>
    <link rel="icon" href="./imgs/icon.png" type="image/png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
        }
        .message-box.error { background-color: #f44336; }
        .message-box.show { opacity: 1; }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toggle-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4f46e5; }
        input:focus + .slider { box-shadow: 0 0 1px #4f46e5; }
        input:checked + .slider:before { transform: translateX(26px); }
        .toggle-label { transition: color .4s; }
        .toggle-label.inactive { color: #9ca3af; }
        /* Custom scrollbar for filters */
        .filter-options::-webkit-scrollbar { width: 5px; }
        .filter-options::-webkit-scrollbar-track { background: #f1f1f1; }
        .filter-options::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 4px; }
        .filter-options::-webkit-scrollbar-thumb:hover { background: #818cf8; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="messageBox" class="message-box"></div>

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-8 md:p-10">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-700">Catálogo de Roupas - Admin</h1>
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-indigo-600 hover:text-indigo-800 font-semibold transition duration-150 ease-in-out">Voltar para a Loja</a>
                <button id="logoutButton" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-150 ease-in-out">
                    Sair
                </button>
            </div>
        </div>

        <!-- Seção de Cadastro/Edição de Roupas -->
        <section class="mb-12 p-6 bg-indigo-50 rounded-lg shadow-md">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-600" id="formTitle">Cadastrar Nova Roupa</h2>
            <form id="cadastroForm" class="space-y-4">
                <input type="hidden" id="roupaId" value="">
                <input type="hidden" id="publicId1" value="">
                <div>
                    <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome da Roupa:</label>
                    <input type="text" id="nome" name="nome" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                </div>
                <div>
                    <label for="marca" class="block text-sm font-medium text-gray-700 mb-1">Marca:</label>
                    <input type="text" id="marca" name="marca" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tamanhos:</label>
                    <div class="flex flex-wrap gap-x-4 gap-y-2">
                        <label class="inline-flex items-center"><input type="checkbox" name="tamanhos" value="PP" class="form-checkbox h-5 w-5 text-indigo-600 rounded"><span class="ml-2 text-gray-700">PP</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="tamanhos" value="P" class="form-checkbox h-5 w-5 text-indigo-600 rounded"><span class="ml-2 text-gray-700">P</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="tamanhos" value="M" class="form-checkbox h-5 w-5 text-indigo-600 rounded"><span class="ml-2 text-gray-700">M</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="tamanhos" value="G" class="form-checkbox h-5 w-5 text-indigo-600 rounded"><span class="ml-2 text-gray-700">G</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="tamanhos" value="GG" class="form-checkbox h-5 w-5 text-indigo-600 rounded"><span class="ml-2 text-gray-700">GG</span></label>
                    </div>
                </div>
                <div>
                    <label for="modelo" class="block text-sm font-medium text-gray-700 mb-1">Modelo:</label>
                    <select id="modelo" name="modelo" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                        <option value="">Selecione um Modelo</option>
                        <option value="Bags">Bags</option>
                        <option value="Bonés">Bonés</option>
                        <option value="Bucket">Bucket</option>
                        <option value="Calças Cargo">Calças Cargo</option>
                        <option value="Camisas Polo">Camisas Polo</option>
                        <option value="Camisas Streetwear">Camisas Streetwear</option>
                        <option value="Moleton">Moleton</option>
                        <option value="Short Suedine">Short Suedine</option>
                        <option value="Camisa de time">Camisa de time</option>
                        <option value="Kits">Kits</option>
                    </select>
                </div>
                <div id="campoTimeContainer" class="hidden">
                    <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Time:</label>
                    <input type="text" id="time" name="time" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                </div>
                <div>
                    <label for="descricao" class="block text-sm font-medium text-gray-700 mb-1">Descrição:</label>
                    <textarea id="descricao" name="descricao" rows="3" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base"></textarea>
                </div>
                <div>
                    <label for="preco" class="block text-sm font-medium text-gray-700 mb-1">Preço (R$):</label>
                    <input type="number" id="preco" name="preco" step="0.01" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                </div>
                <div class="flex items-center gap-4">
                    <label id="promocaoLabel" for="promocaoToggle" class="toggle-label inactive block text-sm font-medium">Em Promoção</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="promocaoToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="precoPromocionalContainer" class="hidden">
                    <label for="precoPromocional" class="block text-sm font-medium text-gray-700 mb-1">Valor da Promoção (R$):</label>
                    <input type="number" id="precoPromocional" name="precoPromocional" step="0.01" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                </div>
                <div>
                    <label for="imageFile1" class="block text-sm font-medium text-gray-700 mb-1">Upload da Imagem:</label>
                    <input type="file" id="imageFile1" name="imageFile1" accept="image/*" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-base">
                    <p id="currentImage1" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button type="submit" id="submitButton" class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out flex items-center justify-center">
                    <span id="buttonText">Cadastrar Roupa</span>
                    <div id="loadingSpinner" class="loading-spinner hidden"></div>
                </button>
                <button type="button" id="cancelEditButton" class="w-full sm:w-auto px-6 py-3 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 transition duration-150 ease-in-out hidden">
                    Cancelar Edição
                </button>
            </form>
        </section>

        <!-- Seção do Catálogo com Filtros -->
        <section>
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-indigo-600 text-center">Nosso Catálogo</h2>
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Barra Lateral de Filtros -->
                <aside class="lg:w-1/4 xl:w-1/5">
                    <div class="space-y-6 sticky top-8">
                        <div>
                            <label for="search-input" class="font-bold text-lg mb-3 border-b pb-2 block">Pesquisar por Nome</label>
                            <input type="text" id="search-input" placeholder="Digite o nome..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-3 border-b pb-2">Marcas</h3>
                            <div id="filterMarca" class="space-y-2 max-h-40 overflow-y-auto pr-2 filter-options"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-3 border-b pb-2">Modelos</h3>
                            <div id="filterModelo" class="space-y-2 max-h-40 overflow-y-auto pr-2 filter-options"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-3 border-b pb-2">Tamanhos</h3>
                            <div id="filterTamanho" class="space-y-2 max-h-40 overflow-y-auto pr-2 filter-options"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-3 border-b pb-2">Promoção</h3>
                            <div id="filterPromocao" class="space-y-2">
                                <label class="flex items-center"><input type="radio" name="promocao" value="todos" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-3 text-sm text-gray-600">Todos</span></label>
                                <label class="flex items-center"><input type="radio" name="promocao" value="sim" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-3 text-sm text-gray-600">Em promoção</span></label>
                                <label class="flex items-center"><input type="radio" name="promocao" value="nao" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-3 text-sm text-gray-600">Sem promoção</span></label>
                            </div>
                        </div>
                        <button id="clearFiltersButton" class="w-full px-4 py-2 bg-gray-600 text-white font-semibold rounded-md shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                            Limpar Filtros
                        </button>
                    </div>
                </aside>

                <!-- Grade de Produtos -->
                <div class="w-full lg:w-3/4 xl:w-4/5">
                    <div id="loading-message" class="text-center py-10"><p class="text-lg text-gray-500">Carregando produtos...</p></div>
                    <div id="no-products-message" class="hidden text-center py-10"><p class="text-lg text-gray-500">Nenhum produto encontrado com os filtros selecionados.</p></div>
                    <div id="catalogo-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Itens do catálogo serão carregados aqui -->
                    </div>
                    <div id="pagination-controls" class="flex justify-center items-center mt-10 space-x-4"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>

    <script>
        // --- Configurações ---
        const firebaseConfig = {
            apiKey: "AIzaSyBk1cV2SQEhEToTdDxqDBTYOHjyogHaOAE",
            authDomain: "bbz-imports.firebaseapp.com",
            databaseURL: "https://bbz-imports-default-rtdb.firebaseio.com",
            projectId: "bbz-imports",
            storageBucket: "bbz-imports.appspot.com",
            messagingSenderId: "184315339952",
            appId: "1:184315339952:web:d8bab53b3a7fae2e6e4775",
            measurementId: "G-QBNJP7HHQB"
        };
        const CLOUDINARY_CLOUD_NAME = 'dv90atoxf';
        const CLOUDINARY_UPLOAD_PRESET = 'catalogo_roupas_preset';

        // --- Inicialização ---
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- Elementos do DOM ---
        const messageBox = document.getElementById('messageBox');
        const cadastroForm = document.getElementById('cadastroForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const formTitle = document.getElementById('formTitle');
        const roupaIdInput = document.getElementById('roupaId');
        const publicIdInput = document.getElementById('publicId1');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const modeloSelect = document.getElementById('modelo');
        const campoTimeContainer = document.getElementById('campoTimeContainer');
        const currentImage1 = document.getElementById('currentImage1');
        const logoutButton = document.getElementById('logoutButton');
        const promocaoToggle = document.getElementById('promocaoToggle');
        const promocaoLabel = document.getElementById('promocaoLabel');
        const precoPromocionalContainer = document.getElementById('precoPromocionalContainer');
        const precoPromocionalInput = document.getElementById('precoPromocional');
        const catalogoContainer = document.getElementById('catalogo-container');
        const paginationControls = document.getElementById('pagination-controls');
        const loadingMessage = document.getElementById('loading-message');
        const noProductsMessage = document.getElementById('no-products-message');
        
        // --- Elementos de Filtro ---
        const searchInput = document.getElementById('search-input');
        const filterMarcaContainer = document.getElementById('filterMarca');
        const filterModeloContainer = document.getElementById('filterModelo');
        const filterTamanhoContainer = document.getElementById('filterTamanho');
        const filterPromocaoContainer = document.getElementById('filterPromocao');
        const clearFiltersButton = document.getElementById('clearFiltersButton');

        // --- Estado da Aplicação ---
        let allProducts = [];
        let currentPage = 1;
        const itemsPerPage = 9;
        let selectedMarcas = new Set();
        let selectedModelos = new Set();
        let selectedTamanhos = new Set();
        let selectedPromocao = 'todos'; // 'todos', 'sim', 'nao'
        let searchTerm = '';

        // --- Funções Auxiliares ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.toggle('error', isError);
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        function setLoadingState(isLoading) {
            submitButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Enviando...' : (roupaIdInput.value ? 'Atualizar Roupa' : 'Cadastrar Roupa');
            loadingSpinner.classList.toggle('hidden', !isLoading);
        }

        // --- Lógica de Promoção (Formulário) ---
        promocaoToggle.addEventListener('change', () => {
            const isChecked = promocaoToggle.checked;
            precoPromocionalContainer.classList.toggle('hidden', !isChecked);
            promocaoLabel.classList.toggle('inactive', !isChecked);
            if (!isChecked) {
                precoPromocionalInput.value = '';
            }
        });

        // --- Lógica do Cloudinary ---
        async function uploadImageToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Erro no upload: ${errorData.error.message}`);
            }
            return response.json();
        }

        // --- Lógica do Formulário ---
        cadastroForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!auth.currentUser) {
                showMessage('Você precisa estar logado.', true);
                return;
            }
            setLoadingState(true);

            const roupaId = roupaIdInput.value;
            const imageFile1 = document.getElementById('imageFile1').files[0];
            let imageUrl1 = currentImage1.dataset.url || '';
            let publicId1 = publicIdInput.value || '';

            try {
                if (imageFile1) {
                    const cloudinaryData = await uploadImageToCloudinary(imageFile1);
                    imageUrl1 = cloudinaryData.secure_url;
                    publicId1 = cloudinaryData.public_id;
                } else if (!roupaId) {
                    throw new Error('A imagem é obrigatória para um novo cadastro.');
                }

                const emPromocao = promocaoToggle.checked;
                const precoPromocionalValue = emPromocao ? parseFloat(precoPromocionalInput.value).toFixed(2) : null;

                if (emPromocao && (!precoPromocionalValue || precoPromocionalValue <= 0)) {
                    throw new Error('O valor promocional é obrigatório quando a promoção está ativa.');
                }

                const roupaData = {
                    nome: document.getElementById('nome').value,
                    marca: document.getElementById('marca').value,
                    descricao: document.getElementById('descricao').value,
                    preco: parseFloat(document.getElementById('preco').value).toFixed(2),
                    modelo: modeloSelect.value,
                    time: modeloSelect.value === 'Camisa de time' ? document.getElementById('time').value : '',
                    tamanhos: Array.from(document.querySelectorAll('input[name="tamanhos"]:checked')).map(cb => cb.value),
                    emPromocao: emPromocao,
                    precoPromocional: precoPromocionalValue,
                    imageUrl1: imageUrl1,
                    publicId1: publicId1,
                };

                const dbRef = roupaId ? database.ref('roupas/' + roupaId) : database.ref('roupas').push();
                if (!roupaId) {
                    roupaData.timestamp = firebase.database.ServerValue.TIMESTAMP;
                }
                
                await dbRef.set(roupaData);
                showMessage(roupaId ? 'Roupa atualizada com sucesso!' : 'Roupa cadastrada com sucesso!');
                resetForm();

            } catch (error) {
                console.error("Erro:", error);
                showMessage(error.message, true);
            } finally {
                setLoadingState(false);
            }
        });
        
        // --- Funções de Edição, Exclusão e Reset ---
        function editRoupa(id) {
            if (!auth.currentUser) {
                showMessage('Você precisa estar logado para editar.', true);
                return;
            }
            const roupa = allProducts.find(p => p.id === id);
            if (roupa) {
                resetForm();
                formTitle.textContent = 'Editar Roupa';
                submitButton.querySelector('#buttonText').textContent = 'Atualizar Roupa';
                cancelEditButton.classList.remove('hidden');
                
                roupaIdInput.value = id;
                publicIdInput.value = roupa.publicId1 || '';
                document.getElementById('nome').value = roupa.nome || '';
                document.getElementById('marca').value = roupa.marca || '';
                document.getElementById('descricao').value = roupa.descricao || '';
                document.getElementById('preco').value = roupa.preco || '';
                modeloSelect.value = roupa.modelo || '';
                
                modeloSelect.dispatchEvent(new Event('change'));
                if (roupa.modelo === 'Camisa de time') {
                    document.getElementById('time').value = roupa.time || '';
                }

                (roupa.tamanhos || []).forEach(tamanho => {
                    const checkbox = document.querySelector(`input[name="tamanhos"][value="${tamanho}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                
                promocaoToggle.checked = roupa.emPromocao || false;
                promocaoToggle.dispatchEvent(new Event('change'));
                if (roupa.emPromocao) {
                    precoPromocionalInput.value = roupa.precoPromocional || '';
                }

                currentImage1.textContent = roupa.imageUrl1 ? `Imagem atual: ${roupa.imageUrl1.substring(0, 40)}...` : 'Nenhuma imagem';
                currentImage1.dataset.url = roupa.imageUrl1 || '';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function deleteRoupa(id, nomeRoupa, publicId) {
            if (!auth.currentUser) {
                showMessage('Você precisa estar logado para excluir.', true);
                return;
            }
            // Use a custom modal in a real app instead of confirm()
            if (window.confirm(`Tem certeza que deseja excluir a roupa "${nomeRoupa}"?`)) {
                try {
                    await database.ref('roupas/' + id).remove();
                    if (publicId) {
                        console.warn(`EXCLUSÃO SEGURA NECESSÁRIA: Implemente uma função de backend para excluir a imagem com public_id '${publicId}' do Cloudinary.`);
                    }
                    showMessage('Roupa excluída com sucesso!');
                } catch (error) {
                    console.error("Erro ao excluir roupa:", error);
                    showMessage('Erro ao excluir roupa.', true);
                }
            }
        }

        function resetForm() {
            cadastroForm.reset();
            roupaIdInput.value = '';
            publicIdInput.value = '';
            formTitle.textContent = 'Cadastrar Nova Roupa';
            submitButton.querySelector('#buttonText').textContent = 'Cadastrar Roupa';
            cancelEditButton.classList.add('hidden');
            promocaoToggle.checked = false;
            promocaoToggle.dispatchEvent(new Event('change'));
            currentImage1.textContent = '';
            currentImage1.dataset.url = '';
            modeloSelect.dispatchEvent(new Event('change'));
        }

        cancelEditButton.addEventListener('click', resetForm);
        modeloSelect.addEventListener('change', () => {
            campoTimeContainer.classList.toggle('hidden', modeloSelect.value !== 'Camisa de time');
            if (modeloSelect.value !== 'Camisa de time') document.getElementById('time').value = '';
        });

        // --- Autenticação ---
        logoutButton.addEventListener('click', () => auth.signOut());
        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = 'login.html';
        });

        // --- Lógica de Filtragem e Paginação ---

        function renderCatalogo(productsToRender) {
            catalogoContainer.innerHTML = '';
            if (productsToRender.length === 0) {
                noProductsMessage.style.display = 'block';
                catalogoContainer.style.display = 'none';
            } else {
                noProductsMessage.style.display = 'none';
                catalogoContainer.style.display = 'grid';
            }

            productsToRender.forEach(roupa => {
                const roupaCard = document.createElement('div');
                roupaCard.className = 'bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105';
                
                let precoHtml = `<p class="text-lg font-bold text-indigo-700">R$ ${parseFloat(roupa.preco).toFixed(2)}</p>`;
                if (roupa.emPromocao && roupa.precoPromocional) {
                    precoHtml = `
                        <div>
                            <p class="text-sm text-gray-500 line-through">R$ ${parseFloat(roupa.preco).toFixed(2)}</p>
                            <p class="text-xl font-bold text-red-600">R$ ${parseFloat(roupa.precoPromocional).toFixed(2)}</p>
                        </div>
                    `;
                }

                roupaCard.innerHTML = `
                    <img src="${roupa.imageUrl1 || 'https://placehold.co/400x200/cccccc/333333?text=Sem+Imagem'}" alt="${roupa.nome}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">${roupa.nome}</h3>
                        <p class="text-gray-600 text-sm mb-1"><strong>Marca:</strong> ${roupa.marca || 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-1"><strong>Modelo:</strong> ${roupa.modelo || 'N/A'}</p>
                        ${roupa.time ? `<p class="text-gray-600 text-sm mb-1"><strong>Time:</strong> ${roupa.time}</p>` : ''}
                        <p class="text-gray-600 text-sm mb-1"><strong>Tamanhos:</strong> ${roupa.tamanhos && roupa.tamanhos.length > 0 ? roupa.tamanhos.join(', ') : 'N/A'}</p>
                        <p class="text-gray-600 text-sm mb-3">${roupa.descricao}</p>
                        ${precoHtml}
                        <div class="mt-4 flex flex-col sm:flex-row gap-2">
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="editRoupa('${roupa.id}')">Editar</button>
                            <button class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" onclick="deleteRoupa('${roupa.id}', '${roupa.nome}', '${roupa.publicId1 || ''}')">Excluir</button>
                        </div>
                    </div>
                `;
                catalogoContainer.appendChild(roupaCard);
            });
        }

        function renderPaginationControls(totalItems, totalPages) {
            paginationControls.innerHTML = '';
            if (totalPages <= 1) return;

            const createButton = (text, page, isDisabled) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `px-4 py-2 rounded-md text-sm font-medium ${isDisabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}`;
                button.disabled = isDisabled;
                button.addEventListener('click', () => {
                    currentPage = page;
                    applyFiltersAndRender();
                    document.querySelector('section').scrollIntoView({ behavior: 'smooth' });
                });
                return button;
            };

            paginationControls.appendChild(createButton('Anterior', currentPage - 1, currentPage === 1));

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            pageInfo.className = 'mx-4 text-gray-700 font-medium text-sm';
            paginationControls.appendChild(pageInfo);

            paginationControls.appendChild(createButton('Próximo', currentPage + 1, currentPage === totalPages));
        }

        function applyFiltersAndRender() {
            let filtered = [...allProducts];

            // 1. Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(p => p.nome.toLowerCase().includes(searchTerm));
            }
            // 2. Filter by brand
            if (selectedMarcas.size > 0) {
                filtered = filtered.filter(p => selectedMarcas.has(p.marca));
            }
            // 3. Filter by model
            if (selectedModelos.size > 0) {
                filtered = filtered.filter(p => selectedModelos.has(p.modelo));
            }
            // 4. Filter by size
            if (selectedTamanhos.size > 0) {
                filtered = filtered.filter(p => p.tamanhos && p.tamanhos.some(t => selectedTamanhos.has(t)));
            }
            // 5. Filter by promotion
            if (selectedPromocao === 'sim') {
                filtered = filtered.filter(p => p.emPromocao);
            } else if (selectedPromocao === 'nao') {
                filtered = filtered.filter(p => !p.emPromocao);
            }

            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (currentPage > totalPages) currentPage = totalPages || 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedProducts = filtered.slice(startIndex, endIndex);

            renderCatalogo(paginatedProducts);
            renderPaginationControls(totalItems, totalPages);
        }

        function createFilterCheckbox(container, value, type, stateSet) {
            const id = `${type}-${value.replace(/\s+/g, '-')}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center';
            wrapper.innerHTML = `
                <input id="${id}" name="${type}" type="checkbox" value="${value}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="${id}" class="ml-3 text-sm text-gray-600">${value}</label>
            `;
            container.appendChild(wrapper);
            wrapper.querySelector('input').addEventListener('change', (e) => {
                if (e.target.checked) {
                    stateSet.add(value);
                } else {
                    stateSet.delete(value);
                }
                currentPage = 1;
                applyFiltersAndRender();
            });
        }

        function populateFilters() {
            const uniqueMarcas = new Set();
            const uniqueModelos = new Set();
            const uniqueTamanhos = new Set();
            allProducts.forEach(p => {
                if (p.marca) uniqueMarcas.add(p.marca);
                if (p.modelo) uniqueModelos.add(p.modelo);
                if (p.tamanhos) p.tamanhos.forEach(t => uniqueTamanhos.add(t));
            });

            filterMarcaContainer.innerHTML = '';
            Array.from(uniqueMarcas).sort().forEach(marca => createFilterCheckbox(filterMarcaContainer, marca, 'marca', selectedMarcas));
            
            filterModeloContainer.innerHTML = '';
            Array.from(uniqueModelos).sort().forEach(modelo => createFilterCheckbox(filterModeloContainer, modelo, 'modelo', selectedModelos));

            filterTamanhoContainer.innerHTML = '';
            Array.from(uniqueTamanhos).sort().forEach(tamanho => createFilterCheckbox(filterTamanhoContainer, tamanho, 'tamanho', selectedTamanhos));
        }
        
        // --- Event Listeners for Filters ---
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            currentPage = 1;
            applyFiltersAndRender();
        });

        filterPromocaoContainer.addEventListener('change', (e) => {
            if (e.target.name === 'promocao') {
                selectedPromocao = e.target.value;
                currentPage = 1;
                applyFiltersAndRender();
            }
        });
        
        clearFiltersButton.addEventListener('click', () => {
            searchInput.value = '';
            searchTerm = '';
            
            selectedMarcas.clear();
            document.querySelectorAll('#filterMarca input').forEach(c => c.checked = false);
            
            selectedModelos.clear();
            document.querySelectorAll('#filterModelo input').forEach(c => c.checked = false);
            
            selectedTamanhos.clear();
            document.querySelectorAll('#filterTamanho input').forEach(c => c.checked = false);
            
            selectedPromocao = 'todos';
            document.querySelector('#filterPromocao input[value="todos"]').checked = true;
            
            currentPage = 1;
            applyFiltersAndRender();
        });

        // --- Carregamento Inicial dos Dados ---
        database.ref('roupas').on('value', (snapshot) => {
            loadingMessage.style.display = 'none';
            const roupas = snapshot.val();
            allProducts = [];

            if (roupas) {
                allProducts = Object.keys(roupas).map(key => ({ id: key, ...roupas[key] })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }
            
            populateFilters();
            applyFiltersAndRender();

        }, (error) => {
            console.error("Erro ao carregar produtos:", error);
            loadingMessage.textContent = 'Falha ao carregar produtos. Tente novamente mais tarde.';
            noProductsMessage.style.display = 'none';
        });
    </script>
</body>
</html>
