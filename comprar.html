<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - BBZ IMPORTS</title>
    <link rel="icon" href="./imgs/icon.png" type="image/png">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Header -->
    <script src="Header.js" defer></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            padding-top: 80px; /* Espaço para o header fixo */
        }
        .message-box {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #22c55e; /* green-500 */
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px) translateX(-50%);
        }
        .message-box.error { background-color: #ef4444; } /* red-500 */
        .message-box.show { 
            opacity: 1; 
            transform: translateY(0) translateX(-50%);
        }
        /* Estilos para o Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1200;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="messageBox" class="message-box"></div>

    <main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div id="loading-container" class="text-center py-10">
            <p class="text-lg text-gray-500">Carregando seu pedido...</p>
        </div>

        <div id="checkout-container" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Coluna da Esquerda: Resumo do Pedido e Endereço -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Resumo do Pedido -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumo do Pedido</h2>
                    <div id="order-summary-container" class="space-y-4">
                        <!-- Itens do pedido serão inseridos aqui -->
                    </div>
                    <div id="empty-cart-view" class="hidden text-center py-8">
                        <p class="text-gray-500">Seu carrinho está vazio.</p>
                        <a href="index.html" class="mt-4 inline-block bg-gray-900 text-white font-semibold px-6 py-2 rounded-lg hover:bg-gray-700">Continuar Comprando</a>
                    </div>
                </div>

                <!-- Seleção de Endereço -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Endereço de Entrega</h2>
                        <button id="add-address-btn" class="hidden px-4 py-2 bg-indigo-600 text-white font-semibold text-sm rounded-lg shadow-sm hover:bg-indigo-700">
                            Adicionar Novo
                        </button>
                    </div>
                    <div id="address-list" class="space-y-3">
                        <!-- Endereços serão listados aqui -->
                    </div>
                    <p id="no-address-msg" class="hidden text-center text-gray-500 py-4">Nenhum endereço cadastrado. Adicione um para continuar.</p>
                </div>
            </div>

            <!-- Coluna da Direita: Finalização -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Finalizar</h2>
                    <div class="space-y-3 text-lg border-b pb-4 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span id="summary-subtotal">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Frete</span>
                            <span class="font-semibold text-green-600">Grátis</span>
                        </div>
                    </div>
                    <div class="flex justify-between font-bold text-2xl mb-6">
                        <span>Total</span>
                        <span id="summary-total">R$ 0,00</span>
                    </div>
                    <button id="finalize-order-button" class="w-full bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="finalize-button-text">Finalizar Pedido</span>
                        <div id="finalize-loading-spinner" class="loading-spinner hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal para Adicionar/Editar Endereço -->
    <div id="address-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Adicionar Novo Endereço</h3>
            <form id="address-form" class="space-y-4">
                <input type="hidden" id="address-id">
                <div>
                    <label for="address-name" class="block text-sm font-medium text-gray-700">Nome do Endereço (ex: Casa, Trabalho)</label>
                    <input type="text" id="address-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="address-cep" class="block text-sm font-medium text-gray-700">CEP</label>
                    <input type="text" id="address-cep" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="address-street" class="block text-sm font-medium text-gray-700">Endereço</label>
                    <input type="text" id="address-street" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="address-number" class="block text-sm font-medium text-gray-700">Número</label>
                        <input type="text" id="address-number" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="address-complement" class="block text-sm font-medium text-gray-700">Complemento</label>
                        <input type="text" id="address-complement" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label for="address-reference" class="block text-sm font-medium text-gray-700">Ponto de Referência</label>
                    <input type="text" id="address-reference" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" id="cancel-address-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // --- Configurações ---
        const firebaseConfig = {
            apiKey: "AIzaSyBk1cV2SQEhEToTdDxqDBTYOHjyogHaOAE",
            authDomain: "bbz-imports.firebaseapp.com",
            databaseURL: "https://bbz-imports-default-rtdb.firebaseio.com",
            projectId: "bbz-imports",
            storageBucket: "bbz-imports.appspot.com",
            messagingSenderId: "184315339952",
            appId: "1:184315339952:web:d8bab53b3a7fae2e6e4775",
            measurementId: "G-QBNJP7HHQB"
        };
        // Chaves do EmailJS fornecidas pelo usuário
        const EMAILJS_SERVICE_ID = 'service_r0279tf';
        const EMAILJS_TEMPLATE_ID = 'template_4kdni7n';
        const EMAILJS_PUBLIC_KEY = 'bzCLFjq1twHQG3V6f';

        // --- Inicialização ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        emailjs.init(EMAILJS_PUBLIC_KEY);

        // --- Elementos do DOM ---
        const loadingContainer = document.getElementById('loading-container');
        const checkoutContainer = document.getElementById('checkout-container');
        const orderSummaryContainer = document.getElementById('order-summary-container');
        const emptyCartView = document.getElementById('empty-cart-view');
        const addressList = document.getElementById('address-list');
        const noAddressMsg = document.getElementById('no-address-msg');
        const addAddressBtn = document.getElementById('add-address-btn');
        const summarySubtotal = document.getElementById('summary-subtotal');
        const summaryTotal = document.getElementById('summary-total');
        const finalizeOrderButton = document.getElementById('finalize-order-button');
        const finalizeButtonText = document.getElementById('finalize-button-text');
        const finalizeLoadingSpinner = document.getElementById('finalize-loading-spinner');
        const messageBox = document.getElementById('messageBox');

        // --- Modal de Endereço ---
        const addressModal = document.getElementById('address-modal');
        const addressForm = document.getElementById('address-form');
        const cancelAddressBtn = document.getElementById('cancel-address-btn');
        const modalTitle = document.getElementById('modal-title');
        const addressIdInput = document.getElementById('address-id');
        const cepInput = document.getElementById('address-cep');

        // --- Estado da Aplicação ---
        let currentUser = null;
        let userData = null;
        let selectedAddressId = null;

        // --- Funções Auxiliares ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'message-box';
            if (isError) messageBox.classList.add('error');
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 4000);
        }

        const getCart = () => JSON.parse(localStorage.getItem('bbzCart')) || [];
        const saveCart = (cart) => localStorage.setItem('bbzCart', JSON.stringify(cart));
        const clearCart = () => localStorage.removeItem('bbzCart');

        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function generateOrderNumber() {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `BBZ-${year}${month}${day}-${random}`;
        }

        // --- Lógica de Renderização ---
        function renderOrderSummary() {
            const cart = getCart();
            orderSummaryContainer.innerHTML = '';
            
            if (cart.length === 0) {
                emptyCartView.classList.remove('hidden');
                finalizeOrderButton.disabled = true;
                summarySubtotal.textContent = formatCurrency(0);
                summaryTotal.textContent = formatCurrency(0);
                return;
            }

            emptyCartView.classList.add('hidden');
            let subtotal = 0;

            cart.forEach((item, index) => {
                const itemPrice = parseFloat(item.price);
                const itemTotal = itemPrice * item.quantity;
                subtotal += itemTotal;

                const itemElement = document.createElement('div');
                itemElement.className = 'flex items-start gap-4 py-4 border-b last:border-b-0';
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-20 h-24 object-cover rounded-md">
                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-500">Tamanho: ${item.size}</p>
                        <p class="text-md font-semibold text-gray-900 mt-1">${formatCurrency(itemPrice)}</p>
                    </div>
                    <div class="flex items-center border rounded-md">
                        <button data-index="${index}" class="quantity-change-btn p-1.5 text-gray-600 hover:bg-gray-100" data-amount="-1">-</button>
                        <span class="px-3 font-medium">${item.quantity}</span>
                        <button data-index="${index}" class="quantity-change-btn p-1.5 text-gray-600 hover:bg-gray-100" data-amount="1">+</button>
                    </div>
                `;
                orderSummaryContainer.appendChild(itemElement);
            });

            summarySubtotal.textContent = formatCurrency(subtotal);
            summaryTotal.textContent = formatCurrency(subtotal);
            checkFinalizeButtonState();
        }

        function renderAddresses(addresses) {
            addressList.innerHTML = '';
            const hasAddresses = addresses && Object.keys(addresses).length > 0;

            noAddressMsg.classList.toggle('hidden', hasAddresses);
            addAddressBtn.classList.toggle('hidden', !hasAddresses && Object.keys(addresses || {}).length >= 3);

            if (!hasAddresses) {
                checkFinalizeButtonState();
                return;
            }
            
            if (!selectedAddressId && hasAddresses) {
                selectedAddressId = Object.keys(addresses)[0];
            }

            for (const addressId in addresses) {
                const address = addresses[addressId];
                const isSelected = addressId === selectedAddressId;
                const addressCard = document.createElement('div');
                addressCard.className = `border-2 rounded-lg p-4 cursor-pointer transition-all ${isSelected ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200 hover:border-gray-400'}`;
                addressCard.dataset.addressId = addressId;
                addressCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">${address.nomeEndereco}</p>
                            <p class="text-sm text-gray-600">${address.endereco}, ${address.numero}</p>
                            <p class="text-sm text-gray-600">${address.cep}, ${address.complemento || ''}</p>
                        </div>
                        ${isSelected ? `<div class="w-5 h-5 bg-indigo-600 rounded-full flex items-center justify-center"><svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>` : `<div class="w-5 h-5 border-2 border-gray-300 rounded-full"></div>`}
                    </div>
                `;
                addressList.appendChild(addressCard);
            }
            checkFinalizeButtonState();
        }
        
        function checkFinalizeButtonState() {
            const cart = getCart();
            if (cart.length > 0 && selectedAddressId) {
                finalizeOrderButton.disabled = false;
            } else {
                finalizeOrderButton.disabled = true;
            }
        }

        // --- Lógica de Interação ---
        orderSummaryContainer.addEventListener('click', (e) => {
            const target = e.target.closest('.quantity-change-btn');
            if (!target) return;
            
            const index = parseInt(target.dataset.index, 10);
            const amount = parseInt(target.dataset.amount, 10);
            const cart = getCart();

            if (cart[index]) {
                cart[index].quantity += amount;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                }
                saveCart(cart);
                renderOrderSummary();
            }
        });

        addressList.addEventListener('click', (e) => {
            const target = e.target.closest('[data-address-id]');
            if (!target) return;
            selectedAddressId = target.dataset.addressId;
            renderAddresses(userData.enderecos);
        });

        // --- Lógica de Finalização do Pedido ---
        finalizeOrderButton.addEventListener('click', async () => {
            if (finalizeOrderButton.disabled) return;

            finalizeButtonText.textContent = 'Processando...';
            finalizeLoadingSpinner.classList.remove('hidden');
            finalizeOrderButton.disabled = true;

            const orderNumber = generateOrderNumber();
            const cart = getCart();
            const finalAddress = userData.enderecos[selectedAddressId];
            const orderTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const orderData = {
                orderNumber: orderNumber,
                user: {
                    uid: currentUser.uid,
                    nome: `${userData.nome} ${userData.sobrenome}`,
                    email: userData.email,
                    telefone: userData.telefone,
                },
                address: finalAddress,
                items: cart,
                total: orderTotal,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                status: 'Pendente'
            };

            try {
                // 1. Salvar no Realtime Database
                await database.ref('pedidos/' + orderNumber).set(orderData);

                // 2. Montar e Enviar Email com EmailJS
                let itemsHtml = '';
                orderData.items.forEach(item => {
                    itemsHtml += `
                        <tr style="border-bottom: 1px solid #dddddd;">
                            <td style="padding: 10px;">
                                <img src="${item.image}" alt="${item.name}" width="60" style="border-radius: 4px;">
                            </td>
                            <td style="padding: 10px; vertical-align: middle;">
                                <strong>${item.name}</strong><br>
                                <span style="color: #555555; font-size: 12px;">Tamanho: ${item.size}</span>
                            </td>
                            <td style="padding: 10px; vertical-align: middle; text-align: center;">${item.quantity}</td>
                            <td style="padding: 10px; vertical-align: middle;">${formatCurrency(item.price)}</td>
                            <td style="padding: 10px; vertical-align: middle; font-weight: bold;">${formatCurrency(item.price * item.quantity)}</td>
                        </tr>
                    `;
                });

                const emailParams = {
                    order_number: orderData.orderNumber,
                    customer_name: orderData.user.nome,
                    customer_email: orderData.user.email,
                    customer_phone: orderData.user.telefone,
                    address_name: orderData.address.nomeEndereco,
                    delivery_address: `${orderData.address.endereco}, ${orderData.address.numero}`,
                    address_complement: orderData.address.complemento || 'N/A',
                    address_cep: orderData.address.cep,
                    items_html: itemsHtml, // Envia a tabela de itens como HTML
                    order_subtotal: formatCurrency(orderData.total),
                    order_total: formatCurrency(orderData.total)
                };

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailParams);
                
                // 3. Limpar carrinho e redirecionar para o WhatsApp
                clearCart();
                showMessage('Seu pedido foi feito com sucesso, ele será finalizado via Whatsapp');
                
                setTimeout(() => {
                    const whatsappNumber = '552198930333';
                    const whatsappMessage = `Desejo finalizar meu pedido numero ${orderNumber}`;
                    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(whatsappMessage)}`;
                    window.location.href = whatsappUrl;
                }, 2000);

            } catch (error) {
                console.error("Erro ao finalizar pedido:", error);
                showMessage('Ocorreu um erro ao processar seu pedido. Tente novamente.', true);
                finalizeButtonText.textContent = 'Finalizar Pedido';
                finalizeLoadingSpinner.classList.add('hidden');
                finalizeOrderButton.disabled = false;
            }
        });

        // --- Lógica do Modal de Endereço ---
        addAddressBtn.addEventListener('click', () => addressModal.classList.remove('hidden'));
        cancelAddressBtn.addEventListener('click', () => addressModal.classList.add('hidden'));

        addressForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const addressData = {
                nomeEndereco: document.getElementById('address-name').value,
                cep: document.getElementById('address-cep').value,
                endereco: document.getElementById('address-street').value,
                numero: document.getElementById('address-number').value,
                complemento: document.getElementById('address-complement').value,
                pontoReferencia: document.getElementById('address-reference').value,
            };

            const ref = database.ref(`clientes/${currentUser.uid}/enderecos`).push(addressData);
            ref.then(() => {
                showMessage('Endereço salvo com sucesso!');
                addressModal.classList.add('hidden');
            }).catch(err => {
                showMessage('Erro ao salvar endereço.', true);
            });
        });

        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado');
                const data = await response.json();
                if (data.erro) throw new Error('CEP inválido');
                document.getElementById('address-street').value = data.logradouro;
            } catch (error) {
                showMessage(error.message, true);
            }
        });

        // --- Lógica de Autenticação e Carregamento Inicial ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                const userRef = database.ref('clientes/' + user.uid);
                
                userRef.on('value', (snapshot) => {
                    userData = snapshot.val();
                    if (userData) {
                        renderAddresses(userData.enderecos || {});
                    }
                    loadingContainer.style.display = 'none';
                    checkoutContainer.classList.remove('hidden');
                    renderOrderSummary();
                });

            } else {
                window.location.href = 'login.html?redirect=comprar.html';
            }
        });
    </script>
</body>
</html>
